<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Workout Nutrition Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóìÔ∏è Enhanced Nutrition Calendar</h1>
            <p>Plan your nutrition strategy with smart completion tracking</p>
        </div>

        <div class="calendar-container">
            <div class="section">
                <h2>‚öôÔ∏è Settings</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter your API key" value="5b7vz3ozlxd42dqx0udbrq7e2">
                    </div>
                    <div class="form-group">
                        <label for="bodyWeight">Body Weight (lbs)</label>
                        <input type="number" id="bodyWeight" min="100" max="250" value="192">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="goals">Current Goals</label>
                        <select id="goals">
                            <option value="weight-loss">Weight Loss</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="performance">Performance Focus</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="legend" id="legend" style="display: none;">
                <div class="legend-item"><div class="legend-color" style="background: #006989;"></div><span>Workout</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #f44336;"></div><span>Race Day</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #B6C454;"></div><span>Carb Loading</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #006989; opacity: 0.5"></div><span>Post-Race Recovery</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #4caf50;"></div><span>Completed Workout</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #4caf50;"></div><span>üìä Nutrition Adjusted</span></div>
            </div>

            <div class="calendar-header" id="calendarHeader" style="display: none;">
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="calendarManager.previousMonth()">‚Äπ Previous</button>
                    <div class="month-year" id="monthYear"></div>
                    <button class="nav-btn" onclick="calendarManager.nextMonth()">Next ‚Ä∫</button>
                </div>
                <button class="button" onclick="calendarManager.goToToday()">Today</button>
            </div>

            <div class="loading" id="loadingState">
                <h3>Loading your enhanced nutrition calendar...</h3>
                <p>Fetching workouts and completion data from Intervals.icu...</p>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <div class="calendar-header-cell">Sun</div>
                <div class="calendar-header-cell">Mon</div>
                <div class="calendar-header-cell">Tue</div>
                <div class="calendar-header-cell">Wed</div>
                <div class="calendar-header-cell">Thu</div>
                <div class="calendar-header-cell">Fri</div>
                <div class="calendar-header-cell">Sat</div>
            </div>
            <div class="mobile-list" id="mobileList"></div>

        </div>
    </div>

    <div class="day-detail-modal" id="dayDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDate">Day Details</h2>
                <button class="modal-close" onclick="calendarManager.closeModal()">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Enhanced Intervals.icu API Module with Completion Data
        const intervalsAPI = {
            // Load workouts for a specific date
            async loadWorkouts(apiKey, athleteId, date) {
                console.log('üî• API: Loading workouts for', date);
                
                const response = await fetch('/api/intervals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        athleteId: athleteId,
                        apiKey: apiKey,
                        date: date
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API response:', data);
                
                return data.events || [];
            },
            
            // Load workouts for multiple dates (for calendar view)
            async loadWorkoutsForDateRange(apiKey, athleteId, startDate, endDate) {
                console.log('üî• API: Loading workouts for range', startDate, 'to', endDate);
                
                const response = await fetch('/api/intervals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        athleteId: athleteId,
                        apiKey: apiKey,
                        oldest: startDate,
                        newest: endDate
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API range response:', data);
                
                return data.events || [];
            },

            // Load completed activity data for a specific workout
            async loadActivityDetails(apiKey, athleteId, activityId) {
                console.log('üéØ API: Loading activity details for', activityId);
                
                try {
                    const response = await fetch('/api/intervals-activity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            athleteId: athleteId,
                            apiKey: apiKey,
                            activityId: activityId
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Activity API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.activity ? this.processActivityData(data.activity) : null;
                    
                } catch (error) {
                    console.warn('Could not load activity details:', error);
                    return null;
                }
            },

            // Process raw activity data into usable completion data
            processActivityData(rawData) {
                return {
                    id: rawData.id,
                    actualDuration: Math.round((rawData.moving_time || rawData.elapsed_time) / 60),
                    avgHeartRate: rawData.average_heartrate,
                    maxHeartRate: rawData.max_heartrate,
                    avgPower: rawData.average_watts,
                    maxPower: rawData.max_watts,
                    avgCadence: rawData.average_cadence,
                    elevationGain: rawData.total_elevation_gain,
                    distance: rawData.distance,
                    avgSpeed: rawData.average_speed,
                    calories: rawData.kilojoules ? Math.round(rawData.kilojoules / 4.184) : null,
                    trainingStressScore: rawData.training_stress_score,
                    perceivedEffort: rawData.perceived_exertion || null,
                    description: rawData.description,
                    workoutCode: rawData.workout_code
                };
            },

            // Enhanced range loading with completion data for past workouts
            async loadWorkoutsForDateRangeWithCompletion(apiKey, athleteId, startDate, endDate) {
                const workouts = await this.loadWorkoutsForDateRange(apiKey, athleteId, startDate, endDate);
                const today = new Date();
                
                // Group workouts by date for efficient processing
                const workoutsByDate = new Map();
                workouts.forEach(workout => {
                    const workoutDate = workout.start_date_local.split('T')[0];
                    if (!workoutsByDate.has(workoutDate)) {
                        workoutsByDate.set(workoutDate, []);
                    }
                    workoutsByDate.get(workoutDate).push(workout);
                });
                
                // Load completion data for past workouts (limit to avoid too many API calls)
                let completionCallsCount = 0;
                const maxCompletionCalls = 20; // Limit to avoid rate limiting
                
                for (const [dateStr, dayWorkouts] of workoutsByDate) {
                    const workoutDate = new Date(dateStr);
                    if (workoutDate < today && completionCallsCount < maxCompletionCalls) {
                        for (const workout of dayWorkouts) {
                            if (workout.id && completionCallsCount < maxCompletionCalls) {
                                try {
                                    const completionData = await this.loadActivityDetails(apiKey, athleteId, workout.id);
                                    if (completionData) {
                                        workout.completionData = completionData;
                                        workout.isCompleted = true;
                                    }
                                    completionCallsCount++;
                                } catch (error) {
                                    console.warn(`Could not load completion data for workout ${workout.id}:`, error);
                                }
                            }
                        }
                    }
                }
                
                console.log(`Loaded completion data for ${completionCallsCount} workouts`);
                return workouts;
            },
            
            // Default athlete ID and API key
            getDefaults() {
                return {
                    athleteId: 'i290140',
                    apiKey: document.getElementById('apiKey')?.value || '5b7vz3ozlxd42dqx0udbrq7e2'
                };
            }
        };

        // Completion Data Storage (in-memory)
        const completionDataStore = {
            data: new Map(),
            
            store(workoutId, date, analysis) {
                const key = `${date}_${workoutId}`;
                this.data.set(key, {
                    ...analysis,
                    timestamp: new Date(),
                    applied: false
                });
            },
            
            get(workoutId, date) {
                const key = `${date}_${workoutId}`;
                return this.data.get(key);
            },
            
            getByDate(date) {
                const results = [];
                for (const [key, value] of this.data) {
                    if (key.startsWith(date + '_')) {
                        results.push(value);
                    }
                }
                return results;
            },
            
            markApplied(workoutId, date) {
                const key = `${date}_${workoutId}`;
                const data = this.data.get(key);
                if (data) {
                    data.applied = true;
                    this.data.set(key, data);
                }
            }
        };

        // Workout Completion Tracker Module
        const workoutCompletionTracker = {
            // Analyze completed workout against planned workout
            analyzeWorkoutCompletion(plannedWorkout, completionData) {
                if (!completionData) return null;
                
                console.log('üéØ Analyzing workout completion:', plannedWorkout.name);
                
                const planned = this.extractPlannedMetrics(plannedWorkout);
                const actual = this.extractActualMetrics(completionData);
                
                const variance = this.calculateVariance(planned, actual);
                const adjustment = this.generateAdjustmentRecommendation(variance, planned, actual);
                
                const analysis = {
                    workoutId: plannedWorkout.id,
                    workoutName: plannedWorkout.name,
                    date: plannedWorkout.start_date_local.split('T')[0],
                    planned,
                    actual,
                    variance,
                    adjustment,
                    severity: this.calculateAdjustmentSeverity(variance),
                    timestamp: new Date()
                };
                
                // Store the analysis
                completionDataStore.store(plannedWorkout.id, analysis.date, analysis);
                
                return analysis;
            },
            
            extractPlannedMetrics(plannedWorkout) {
                const plannedDuration = Math.round((plannedWorkout.moving_time || plannedWorkout.duration || 3600) / 60);
                const plannedIntensity = this.mapWorkoutTypeToIntensity(plannedWorkout);
                
                return {
                    duration: plannedDuration,
                    intensity: plannedIntensity,
                    intensityScore: this.getIntensityScore(plannedIntensity),
                    estimatedStress: this.calculateStressScore(plannedDuration, plannedIntensity),
                    type: plannedWorkout.type || 'workout'
                };
            },
            
            extractActualMetrics(completionData) {
                const actualIntensity = this.calculateActualIntensity(completionData);
                
                return {
                    duration: completionData.actualDuration,
                    intensity: actualIntensity,
                    intensityScore: this.getIntensityScore(actualIntensity),
                    actualStress: this.calculateStressScore(completionData.actualDuration, actualIntensity),
                    avgHeartRate: completionData.avgHeartRate,
                    maxHeartRate: completionData.maxHeartRate,
                    avgPower: completionData.avgPower,
                    perceivedEffort: completionData.perceivedEffort,
                    calories: completionData.calories,
                    tss: completionData.trainingStressScore
                };
            },
            
            mapWorkoutTypeToIntensity(workout) {
                const name = (workout.name || '').toLowerCase();
                const type = (workout.type || '').toLowerCase();
                
                if (name.includes('recovery') || name.includes('easy')) return 'easy';
                if (name.includes('tempo') || name.includes('zone 3')) return 'tempo';
                if (name.includes('threshold') || name.includes('zone 4')) return 'threshold';
                if (name.includes('interval') || name.includes('zone 5')) return 'intervals';
                if (name.includes('strength endurance') || name.includes('low cadence')) return 'intervals';
                if (name.includes('strength') || type.includes('strength')) return 'strength';
                
                return 'endurance';
            },
            
            calculateActualIntensity(completionData) {
                // Use RPE if available (most reliable)
                if (completionData.perceivedEffort) {
                    if (completionData.perceivedEffort <= 3) return 'easy';
                    if (completionData.perceivedEffort <= 5) return 'endurance';
                    if (completionData.perceivedEffort <= 6) return 'tempo';
                    if (completionData.perceivedEffort <= 8) return 'threshold';
                    return 'intervals';
                }
                
                // Use heart rate zones if available
                if (completionData.avgHeartRate && completionData.maxHeartRate) {
                    const hrPercent = completionData.avgHeartRate / completionData.maxHeartRate;
                    if (hrPercent < 0.65) return 'easy';
                    if (hrPercent < 0.75) return 'endurance';
                    if (hrPercent < 0.85) return 'tempo';
                    if (hrPercent < 0.92) return 'threshold';
                    return 'intervals';
                }
                
                // Use TSS if available
                if (completionData.trainingStressScore) {
                    const tssPerHour = completionData.trainingStressScore / (completionData.actualDuration / 60);
                    if (tssPerHour < 60) return 'easy';
                    if (tssPerHour < 80) return 'endurance';
                    if (tssPerHour < 100) return 'tempo';
                    if (tssPerHour < 120) return 'threshold';
                    return 'intervals';
                }
                
                // Fallback to duration-based estimation
                if (completionData.actualDuration > 150) return 'endurance';
                if (completionData.actualDuration < 45) return 'intervals';
                return 'tempo';
            },
            
            getIntensityScore(intensity) {
                const scores = { 'easy': 1, 'endurance': 2, 'tempo': 3, 'threshold': 4, 'intervals': 5, 'strength': 2 };
                return scores[intensity] || 2;
            },
            
            calculateStressScore(duration, intensity) {
                const intensityMultipliers = { 
                    'easy': 0.6, 
                    'endurance': 1.0, 
                    'tempo': 1.4, 
                    'threshold': 1.8, 
                    'intervals': 2.2,
                    'strength': 1.2
                };
                return (duration / 60) * (intensityMultipliers[intensity] || 1.0);
            },
            
            calculateVariance(planned, actual) {
                return {
                    durationVariance: (actual.duration - planned.duration) / planned.duration,
                    intensityVariance: (actual.intensityScore - planned.intensityScore) / planned.intensityScore,
                    stressVariance: (actual.actualStress - planned.estimatedStress) / planned.estimatedStress,
                    absoluteDurationDiff: actual.duration - planned.duration,
                    absoluteIntensityDiff: actual.intensityScore - planned.intensityScore
                };
            },
            
            calculateAdjustmentSeverity(variance) {
                const totalVariance = Math.abs(variance.durationVariance) + Math.abs(variance.intensityVariance);
                
                if (totalVariance > 0.8) return 'high';
                if (totalVariance > 0.4) return 'medium';
                if (totalVariance > 0.15) return 'low';
                return 'none';
            },
            
            generateAdjustmentRecommendation(variance, planned, actual) {
                if (this.calculateAdjustmentSeverity(variance) === 'none') {
                    return null;
                }
                
                let calorieAdjustment = 0;
                let carbAdjustment = 0;
                let proteinAdjustment = 0;
                const reasoning = [];
                
                // Duration-based adjustments
                if (Math.abs(variance.durationVariance) > 0.15) {
                    const durationMinutes = variance.absoluteDurationDiff;
                    const durationCalories = durationMinutes * 10;
                    calorieAdjustment += durationCalories;
                    carbAdjustment += durationCalories * 0.6 / 4;
                    
                    reasoning.push(
                        durationMinutes > 0 
                            ? `Workout was ${Math.round(Math.abs(variance.durationVariance) * 100)}% longer than planned (+${durationMinutes} min)`
                            : `Workout was ${Math.round(Math.abs(variance.durationVariance) * 100)}% shorter than planned (${durationMinutes} min)`
                    );
                }
                
                // Intensity-based adjustments
                if (Math.abs(variance.intensityVariance) > 0.2) {
                    const intensityCalories = variance.absoluteIntensityDiff * 120;
                    calorieAdjustment += intensityCalories;
                    carbAdjustment += intensityCalories * 0.7 / 4;
                    
                    reasoning.push(
                        variance.intensityVariance > 0
                            ? `Workout was more intense than planned (${actual.intensity} vs ${planned.intensity})`
                            : `Workout was less intense than planned (${actual.intensity} vs ${planned.intensity})`
                    );
                }
                
                // High stress/RPE adjustments
                if (actual.perceivedEffort && actual.perceivedEffort >= 8) {
                    calorieAdjustment += 150;
                    proteinAdjustment += 10;
                    reasoning.push(`High perceived effort (RPE ${actual.perceivedEffort}) - increasing recovery nutrition`);
                }
                
                // TSS-based fine-tuning
                if (actual.tss && actual.tss > 100) {
                    calorieAdjustment += Math.min(100, (actual.tss - 100) * 2);
                    reasoning.push(`High training stress (TSS: ${actual.tss}) detected`);
                }
                
                if (!proteinAdjustment) {
                    proteinAdjustment = Math.round(calorieAdjustment * 0.15 / 4);
                }
                const fatAdjustment = Math.round(calorieAdjustment * 0.25 / 9);
                
                return {
                    calories: Math.round(calorieAdjustment),
                    carbs: Math.round(carbAdjustment),
                    protein: proteinAdjustment,
                    fat: fatAdjustment,
                    reasoning: reasoning,
                    timing: this.getTimingRecommendations(variance, actual),
                    recovery: this.getRecoveryRecommendations(actual)
                };
            },
            
            getTimingRecommendations(variance, actual) {
                const recommendations = [];
                
                if (variance.intensityVariance > 0.3 || (actual.perceivedEffort && actual.perceivedEffort >= 7)) {
                    recommendations.push('Prioritize post-workout nutrition within 30 minutes');
                    recommendations.push('Increase carb intake in the 2 hours post-workout');
                }
                
                if (variance.durationVariance > 0.3) {
                    recommendations.push('Extend post-workout fueling window');
                    recommendations.push('Consider larger evening meal to support recovery');
                }
                
                if (actual.actualDuration > 120) {
                    recommendations.push('Focus on glycogen replenishment over next 24 hours');
                }
                
                return recommendations;
            },
            
            getRecoveryRecommendations(actual) {
                const recommendations = [];
                
                if (actual.perceivedEffort && actual.perceivedEffort >= 8) {
                    recommendations.push('Prioritize hydration and electrolyte replacement');
                    recommendations.push('Consider anti-inflammatory foods (tart cherry, turmeric)');
                    recommendations.push('Ensure adequate sleep (8+ hours)');
                }
                
                if (actual.tss && actual.tss > 150) {
                    recommendations.push('High stress session - extra recovery focus needed');
                    recommendations.push('Consider lighter training tomorrow');
                }
                
                if (actual.actualDuration > 180) {
                    recommendations.push('Long session - monitor hydration status');
                    recommendations.push('Split tomorrow\'s nutrition into smaller, frequent meals');
                }
                
                return recommendations;
            },
            
            applyAdjustmentToNutrition(baseNutrition, adjustment) {
                if (!adjustment) return baseNutrition;
                
                return {
                    ...baseNutrition,
                    calories: baseNutrition.calories + adjustment.calories,
                    protein: baseNutrition.protein + adjustment.protein,
                    carbs: baseNutrition.carbs + adjustment.carbs,
                    fat: baseNutrition.fat + adjustment.fat,
                    adjustmentApplied: true,
                    adjustmentDetails: {
                        reason: adjustment.reasoning.join('; '),
                        timing: adjustment.timing,
                        recovery: adjustment.recovery,
                        originalPlan: {
                            calories: baseNutrition.calories,
                            protein: baseNutrition.protein,
                            carbs: baseNutrition.carbs,
                            fat: baseNutrition.fat
                        }
                    }
                };
            }
        };

        // Enhanced Nutrition Calculator with Completion Adjustments
        const nutritionCalculator = {
            calculate(bodyWeightLbs = null, goals = null, workoutType = null, duration = null, isRaceDay = false, isPostRace = false, isCarboLoading = false, completionAdjustments = null) {
                const bw = bodyWeightLbs !== null ? bodyWeightLbs : parseInt(document.getElementById('bodyWeight').value);
                const currentGoals = goals !== null ? goals : document.getElementById('goals').value;
                const wt = workoutType !== null ? workoutType : document.getElementById('workoutType')?.value || 'none';
                const dur = duration !== null ? duration : parseInt(document.getElementById('duration')?.value || 0);
                
                const bodyWeightKg = bw * 0.453592;

                const baseMacros = this.calculateMacros(bodyWeightKg, wt, dur, isRaceDay, isPostRace, isCarboLoading, currentGoals);
                const dailyCalories = (baseMacros.protein * 4) + (baseMacros.carbs * 4) + (baseMacros.fat * 9);
                const fueling = this.calculateWorkoutFueling(wt, dur, isRaceDay);

                let finalNutrition = {
                    calories: Math.round(dailyCalories),
                    ...baseMacros,
                    fueling: fueling,
                    adjustmentApplied: false
                };

                // Apply completion-based adjustments if available
                if (completionAdjustments) {
                    finalNutrition = workoutCompletionTracker.applyAdjustmentToNutrition(finalNutrition, completionAdjustments);
                }

                return finalNutrition;
            },

            // Enhanced calculation that considers completion data for a specific date
            calculateWithCompletionData(bodyWeightLbs, goals, workoutType, duration, date, workouts = null) {
                // Start with base calculation
                let nutrition = this.calculate(bodyWeightLbs, goals, workoutType, duration);
                
                // Check if we have completion data for this date
                if (workouts && workouts.length > 0) {
                    const completionAdjustments = this.analyzeWorkoutsForAdjustments(workouts, date);
                    if (completionAdjustments) {
                        nutrition = workoutCompletionTracker.applyAdjustmentToNutrition(nutrition, completionAdjustments);
                    }
                }
                
                return nutrition;
            },

            // Analyze workouts for completion-based adjustments
            analyzeWorkoutsForAdjustments(workouts, date) {
                const selectedDate = new Date(date);
                const today = new Date();
                
                // Only apply adjustments for past dates
                if (selectedDate >= today) return null;
                
                let totalAdjustment = {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    reasoning: [],
                    timing: [],
                    recovery: []
                };
                
                let hasAdjustments = false;
                
                workouts.forEach(workout => {
                    if (workout.isCompleted && workout.completionData) {
                        const analysis = workoutCompletionTracker.analyzeWorkoutCompletion(workout, workout.completionData);
                        
                        if (analysis && analysis.adjustment) {
                            const adj = analysis.adjustment;
                            totalAdjustment.calories += adj.calories;
                            totalAdjustment.carbs += adj.carbs;
                            totalAdjustment.protein += adj.protein;
                            totalAdjustment.fat += adj.fat;
                            totalAdjustment.reasoning.push(...adj.reasoning);
                            totalAdjustment.timing.push(...adj.timing);
                            totalAdjustment.recovery.push(...adj.recovery);
                            hasAdjustments = true;
                        }
                    }
                });
                
                return hasAdjustments ? totalAdjustment : null;
            },

            calculateMacros(bodyWeightKg, workoutType, duration, isRaceDay, isPostRace, isCarboLoading, goals) {
                let p_mult, f_mult, c_mult;

                if (isRaceDay) {
                    p_mult = 2.2; f_mult = 1.7; c_mult = 8.6;
                } else if (isPostRace) {
                    p_mult = 1.7; f_mult = 1.0; c_mult = 5.2;
                } else if (isCarboLoading) {
                    p_mult = 1.7; f_mult = 1.0; c_mult = 8.2;
                } else {
                    switch (workoutType) {
                        case 'none':
                        case 'easy':
                            p_mult = 1.8; f_mult = 1.0; c_mult = 2.5; 
                            break;
                        case 'endurance':
                            p_mult = 1.8; f_mult = 1.1; c_mult = 4.3 + (duration > 120 ? 1.0 : 0);
                            break;
                        case 'tempo':
                        case 'threshold':
                        case 'intervals':
                             p_mult = 1.7; f_mult = 1.0; c_mult = 6.4;
                             break;
                        case 'strength':
                             p_mult = 1.9; f_mult = 1.1; c_mult = 3.5;
                             break;
                        default:
                            p_mult = 1.7; f_mult = 1.0; c_mult = 2.5;
                    }
                }
                
                const isRegularDay = !isRaceDay && !isPostRace && !isCarboLoading;
                if (isRegularDay) {
                    switch(goals) {
                        case 'weight-loss':
                            if (workoutType === 'none' || workoutType === 'easy') {
                                p_mult = 1.72; f_mult = 0.92; c_mult = 1.95;
                            } else {
                                f_mult = Math.max(0.8, f_mult - 0.2);
                                c_mult = Math.max(2.0, c_mult - 1.0);
                            }
                            break;
                        
                        case 'performance':
                            p_mult += 0.2;
                            c_mult += 1.5;
                            break;

                        case 'maintenance':
                            break;
                    }
                }

                return {
                    protein: Math.round(bodyWeightKg * p_mult),
                    fat: Math.round(bodyWeightKg * f_mult),
                    carbs: Math.round(bodyWeightKg * c_mult)
                };
            },

            calculateWorkoutFueling(workoutType, duration, isRaceDay) {
                let duringWorkoutCarbs = 0;
                let fuelingTips = [];

                if (isRaceDay) {
                    duringWorkoutCarbs = 90;
                    fuelingTips.push('RACE FUEL: Aim for 90-120g carbs/hr. This is your primary goal.');
                } else if (duration >= 60 && duration <= 90) {
                    duringWorkoutCarbs = 40;
                    fuelingTips.push('Start fueling within the first 15 minutes.');
                } else if (duration > 90) {
                    duringWorkoutCarbs = 60;
                    if (['tempo', 'threshold', 'intervals'].includes(workoutType)) {
                        duringWorkoutCarbs = 80;
                    }
                    fuelingTips.push('Start fueling early and dose frequently.');
                } else {
                    fuelingTips.push('No in-session fueling required for this workout.');
                }

                return {
                    preWorkoutCarbs: 'Varies',
                    duringWorkoutCarbs: duringWorkoutCarbs,
                    postWorkoutCarbs: 'Varies',
                    fluidIntake: 750,
                    fuelingTips
                };
            },

            formatNutritionResults(nutrition) {
                let html = `
                    <div class="nutrition-card">
                        <h3>üéØ Daily Nutrition Target</h3>
                        <div class="macro-grid">
                            <div class="macro-item">
                                <div class="macro-value">${nutrition.calories}</div>
                                <div class="macro-label">Calories</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value">${nutrition.protein}g</div>
                                <div class="macro-label">Protein</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value">${nutrition.carbs}g</div>
                                <div class="macro-label">Carbs</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value">${nutrition.fat}g</div>
                                <div class="macro-label">Fat</div>
                            </div>
                        </div>
                `;

                if (nutrition.adjustmentApplied && nutrition.adjustmentDetails) {
                    html += `
                        <div class="adjustment-notice">
                            <h4>üìä Workout Completion Adjustment Applied</h4>
                            <p><strong>Reason:</strong> ${nutrition.adjustmentDetails.reason}</p>
                            <div class="adjustment-details">
                                <p><strong>Original plan:</strong> ${nutrition.adjustmentDetails.originalPlan.calories} cal, ${nutrition.adjustmentDetails.originalPlan.carbs}g C, ${nutrition.adjustmentDetails.originalPlan.protein}g P</p>
                                <p><strong>Adjustment:</strong> ${nutrition.calories - nutrition.adjustmentDetails.originalPlan.calories > 0 ? '+' : ''}${nutrition.calories - nutrition.adjustmentDetails.originalPlan.calories} cal</p>
                            </div>
                    `;

                    if (nutrition.adjustmentDetails.timing && nutrition.adjustmentDetails.timing.length > 0) {
                        html += `
                            <div class="timing-recommendations">
                                <h5>‚è∞ Timing Recommendations:</h5>
                                <ul>
                                    ${nutrition.adjustmentDetails.timing.map(tip => `<li>${tip}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (nutrition.adjustmentDetails.recovery && nutrition.adjustmentDetails.recovery.length > 0) {
                        html += `
                            <div class="recovery-recommendations">
                                <h5>üîÑ Recovery Focus:</h5>
                                <ul>
                                    ${nutrition.adjustmentDetails.recovery.map(tip => `<li>${tip}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    html += `</div>`;
                }

                if (nutrition.fueling) {
                    html += `
                        <div class="fueling-notes">
                            <h4>‚ö° Workout Fueling</h4>
                            <p><strong>During workout:</strong> ${nutrition.fueling.duringWorkoutCarbs}g carbs/hour</p>
                            <p><strong>Fluid intake:</strong> ${nutrition.fueling.fluidIntake}ml/hour</p>
                            <ul>
                                ${nutrition.fueling.fuelingTips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                html += `</div>`;
                return html;
            }
        };

        // Enhanced Calendar Manager
        const calendarManager = {
            currentDate: new Date(),
            events: [],
            bodyWeight: 192,
            goals: 'performance',

            workoutMapper: {
                map(workout) {
                    const name = (workout.name || '').toLowerCase();
                    const type = (workout.type || '').toLowerCase();
                    if (name.includes('recovery') || name.includes('easy')) return 'easy';
                    if (name.includes('tempo') || name.includes('zone 3')) return 'tempo';
                    if (name.includes('threshold') || name.includes('zone 4')) return 'threshold';
                    if (name.includes('interval') || name.includes('zone 5')) return 'intervals';
                    if (name.includes('strength endurance') || name.includes('low cadence')) return 'intervals';
                    if (name.includes('strength') || type.includes('strength')) return 'strength';
                    return 'endurance';
                }
            },
            
            init() {
                this.updateMonthYear();
                this.loadCalendarData(); 
                
                document.getElementById('goals')?.addEventListener('change', () => this.handleSettingsChange());
                document.getElementById('bodyWeight')?.addEventListener('change', () => this.handleSettingsChange());
                document.getElementById('apiKey')?.addEventListener('change', () => this.handleSettingsChange());

                document.querySelector('.day-detail-modal')?.addEventListener('click', (e) => this.handleModalClick(e));
                document.querySelector('.modal-close')?.addEventListener('click', () => this.closeModal());
            },
            
            handleSettingsChange() {
                this.bodyWeight = parseInt(document.getElementById('bodyWeight').value);
                this.goals = document.getElementById('goals').value;
                if (this.events.length > 0) {
                    this.renderCalendar();
                } else {
                    this.loadCalendarData();
                }
            },

            async loadCalendarData() {
                const apiKey = document.getElementById('apiKey').value;
                this.bodyWeight = parseInt(document.getElementById('bodyWeight').value);
                this.goals = document.getElementById('goals').value;
                
                if (!apiKey) {
                    document.getElementById('loadingState').innerHTML = `<h3>Please enter your Intervals.icu API Key</h3>`;
                    return;
                }
                
                const loadingState = document.getElementById('loadingState');
                loadingState.innerHTML = '<h3>Loading your enhanced nutrition calendar...</h3><p>Fetching workouts and completion data from Intervals.icu...</p>';
                loadingState.style.display = 'block';
                
                try {
                    const startDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
                    const endDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 2, 0);
                    
                    const { athleteId } = intervalsAPI.getDefaults();
                    
                    this.events = await intervalsAPI.loadWorkoutsForDateRangeWithCompletion(
                        apiKey, athleteId, this.formatDate(startDate), this.formatDate(endDate)
                    );
                    
                    const completedCount = this.events.filter(e => e.isCompleted).length;
                    console.log(`Loaded ${this.events.length} events for calendar (${completedCount} with completion data)`);
                    
                    loadingState.style.display = 'none';
                    document.getElementById('legend').style.display = 'flex';
                    document.getElementById('calendarHeader').style.display = 'flex';
                    
                    this.renderCalendar();
                } catch (error) {
                    console.error('Calendar loading error:', error);
                    loadingState.innerHTML = `<h3>Error loading calendar. Check your API key.</h3><p>${error.message}</p>`;
                }
            },
            
            renderCalendar() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                this.updateMonthYear();
                
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = `
                    <div class="calendar-header-cell">Sun</div><div class="calendar-header-cell">Mon</div>
                    <div class="calendar-header-cell">Tue</div><div class="calendar-header-cell">Wed</div>
                    <div class="calendar-header-cell">Thu</div><div class="calendar-header-cell">Fri</div>
                    <div class="calendar-header-cell">Sat</div>
                `;
                
                const mobileList = document.getElementById('mobileList');
                mobileList.innerHTML = '';
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                
                const allDays = [];
                
                const prevMonth = new Date(year, month, 0);
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    const day = prevMonth.getDate() - i;
                    const fullDate = new Date(year, month - 1, day);
                    grid.appendChild(this.createDayElement(day, true, fullDate));
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const fullDate = new Date(year, month, day);
                    grid.appendChild(this.createDayElement(day, false, fullDate));
                    allDays.push({ day, fullDate, isCurrentMonth: true });
                }
                
                const totalCells = startingDayOfWeek + daysInMonth;
                const cellsNeeded = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);

                for (let day = 1; day <= cellsNeeded; day++) {
                    const fullDate = new Date(year, month + 1, day);
                    grid.appendChild(this.createDayElement(day, true, fullDate));
                }
                
                this.renderMobileList(allDays);
            },
            
            renderMobileList(allDays) {
                const mobileList = document.getElementById('mobileList');
                allDays.forEach(({ day, fullDate, isCurrentMonth }) => {
                    if (!isCurrentMonth) return;
                    
                    const dayEvents = this.getEventsForDate(fullDate);
                    const { raceInfo, isCarboLoading, isPostRace } = this.analyzeDayType(fullDate);
                    
                    const listItem = document.createElement('div');
                    listItem.className = 'day-list-item';
                    
                    const today = new Date();
                    if (this.isSameDate(fullDate, today)) listItem.classList.add('today');
                    if (raceInfo) listItem.classList.add('race-day');
                    else if (isCarboLoading) listItem.classList.add('carb-loading');
                    else if (isPostRace) listItem.classList.add('post-race'); 

                    const hasCompletedWorkouts = dayEvents.some(e => e.isCompleted);
                    if (hasCompletedWorkouts) listItem.classList.add('completed-workout');

                    const nutrition = this.calculateDayNutrition(dayEvents, raceInfo, isCarboLoading, isPostRace, fullDate);
                    
                    listItem.innerHTML = `
                        <div class="day-list-header">
                            <div class="day-list-date">${this.formatDateDisplay(fullDate)}</div>
                            <div>
                                ${raceInfo ? 'üèÅ Race' : isCarboLoading ? 'üçù Carb Load' : isPostRace ? '‚úÖ Recovery' : ''}
                                ${hasCompletedWorkouts ? 'üìä Completed' : ''}
                            </div>
                        </div>
                        <div class="day-list-workouts">
                            ${dayEvents.map(e => `
                                <div>
                                    <strong>${e.name}</strong> (${Math.round((e.moving_time||0)/60)} min)
                                    ${e.isCompleted ? '‚úÖ' : ''}
                                    ${e.completionData && e.completionData.perceivedEffort ? ` RPE: ${e.completionData.perceivedEffort}` : ''}
                                </div>
                            `).join('') || 'Rest Day'}
                        </div>
                        <div class="day-list-nutrition">
                            <strong>${nutrition.calories}</strong> cal ‚Ä¢ <strong>${nutrition.carbs}g</strong> C ‚Ä¢ <strong>${nutrition.protein}g</strong> P
                            ${nutrition.adjustmentApplied ? ' üìä Adjusted' : ''}
                        </div>
                    `;
                    
                    listItem.addEventListener('click', () => this.showDayDetails(fullDate, dayEvents, raceInfo, isCarboLoading, isPostRace));
                    mobileList.appendChild(listItem);
                });
            },
            
            createDayElement(day, isOtherMonth, fullDate) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                if (isOtherMonth) dayElement.classList.add('other-month');

                const today = new Date();
                if (this.isSameDate(fullDate, today)) dayElement.classList.add('today');
                
                const dayEvents = this.getEventsForDate(fullDate);
                const { raceInfo, isCarboLoading, isPostRace } = this.analyzeDayType(fullDate);
                
                const hasCompletedWorkouts = dayEvents.some(e => e.isCompleted);
                const hasAdjustments = dayEvents.some(e => e.isCompleted && e.completionData);
                
                if (raceInfo) dayElement.classList.add('race-day');
                else if (isCarboLoading) dayElement.classList.add('carb-loading');
                else if (isPostRace) dayElement.classList.add('post-race'); 
                
                if (hasCompletedWorkouts) dayElement.classList.add('completed-workout');
                
                const nutritionInfo = this.calculateDayNutrition(dayEvents, raceInfo, isCarboLoading, isPostRace, fullDate);

                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-content">
                        ${raceInfo ? `<div class="race-badge">${raceInfo.category.replace('RACE_', '')}</div>` : ''}
                        ${isCarboLoading ? `<div class="carb-loading-badge">CARB</div>` : ''}
                        ${isPostRace ? `<div class="post-race-badge">RECOVERY</div>` : ''}
                        ${hasAdjustments ? `<div class="adjustment-badge">üìä</div>` : ''}
                        ${dayEvents.map(e => `
                            <div class="workout-item ${e.isCompleted ? 'completed' : ''}">
                                ${e.name}
                                ${e.isCompleted ? ' ‚úÖ' : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="nutrition-info">
                        <strong>${nutritionInfo.calories}</strong> cal / <strong>${nutritionInfo.carbs}g</strong> C
                        ${nutritionInfo.adjustmentApplied ? ' üìä' : ''}
                    </div>
                `;
                
                dayElement.addEventListener('click', () => this.showDayDetails(fullDate, dayEvents, raceInfo, isCarboLoading, isPostRace));
                return dayElement;
            },
            
            getEventsForDate(date) {
                const dateStr = this.formatDate(date);
                return this.events.filter(event => event.start_date_local.startsWith(dateStr));
            },

            analyzeDayType(date) {
                const dayEvents = this.getEventsForDate(date);
                let raceInfo = dayEvents.find(e => e.category?.startsWith('RACE_')) || null;
                let isCarboLoading = false;
                let isPostRace = false;

                const yesterday = new Date(date);
                yesterday.setDate(date.getDate() - 1);
                if (this.getEventsForDate(yesterday).some(e => e.category?.startsWith('RACE_'))) {
                    isPostRace = true;
                    return { raceInfo: null, isCarboLoading: false, isPostRace: true };
                }

                if (raceInfo) {
                    return { raceInfo, isCarboLoading: false, isPostRace: false };
                }

                const upcomingRaces = this.findUpcomingRaces(date, 4); 
                const importantRace = upcomingRaces.find(r => r.category === 'RACE_A' || r.category === 'RACE_B');
                
                if (importantRace) {
                    const raceDate = new Date(importantRace.start_date_local.split('T')[0] + 'T12:00:00');
                    const daysUntilRace = this.calculateDaysUntilRace(date, raceDate);
                    if (daysUntilRace >= 1 && daysUntilRace <= 3) {
                        isCarboLoading = true;
                    }
                }
                
                return { raceInfo, isCarboLoading, isPostRace };
            },
            
            calculateDaysUntilRace(fromDate, raceDate) {
                const from = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
                const race = new Date(raceDate.getFullYear(), raceDate.getMonth(), raceDate.getDate());
                return Math.round((race - from) / (1000 * 60 * 60 * 24));
            },
            
            findUpcomingRaces(fromDate, daysAhead) {
                const endDate = new Date(fromDate);
                endDate.setDate(fromDate.getDate() + daysAhead);
                return this.events.filter(event => {
                    if (!event.category?.startsWith('RACE_')) return false;
                    const eventDate = new Date(event.start_date_local.split('T')[0] + 'T12:00:00');
                    return eventDate > fromDate && eventDate <= endDate;
                });
            },

            calculateDayNutrition(dayEvents, raceInfo, isCarboLoading, isPostRace, date) {
                const totalDuration = dayEvents.reduce((acc, e) => acc + Math.round((e.moving_time || e.duration || 0) / 60), 0);
                
                let highestIntensity = 'none';
                const intensityRanking = { 'none': 0, 'easy': 1, 'strength': 2, 'endurance': 3, 'tempo': 4, 'threshold': 5, 'intervals': 6 };
                
                dayEvents.forEach(event => {
                    const workoutType = this.workoutMapper.map(event);
                    if (intensityRanking[workoutType] > intensityRanking[highestIntensity]) {
                        highestIntensity = workoutType;
                    }
                });
                
                return nutritionCalculator.calculateWithCompletionData(
                    this.bodyWeight, 
                    this.goals, 
                    highestIntensity, 
                    totalDuration,
                    date,
                    dayEvents
                );
            },
            
            showDayDetails(date, dayEvents, raceInfo, isCarboLoading, isPostRace) {
                const modal = document.getElementById('dayDetailModal');
                const modalDate = document.getElementById('modalDate');
                const modalContent = document.getElementById('modalContent');
                
                modalDate.textContent = this.formatDateDisplay(date);
                
                const nutrition = this.calculateDayNutrition(dayEvents, raceInfo, isCarboLoading, isPostRace, date);
                
                let headerText = 'üìÖ Training Day';
                if (raceInfo) headerText = `üèÅ Race Day: ${raceInfo.name}`;
                else if (isPostRace) headerText = '‚úÖ Post-Race Recovery';
                else if (isCarboLoading) headerText = 'üçù Carb Loading Day';
                
                let workoutDetailsHtml = '';
                if (dayEvents.length > 0) {
                    workoutDetailsHtml = `
                        <h4>Scheduled Workouts:</h4>
                        <ul>
                            ${dayEvents.map(e => {
                                let workoutHtml = `<li><strong>${e.name || e.type}</strong> - ${Math.round((e.moving_time || e.duration || 3600) / 60)} minutes`;
                                
                                if (e.isCompleted && e.completionData) {
                                    const completion = e.completionData;
                                    workoutHtml += ` ‚úÖ`;
                                    if (completion.perceivedEffort) {
                                        workoutHtml += ` (RPE: ${completion.perceivedEffort})`;
                                    }
                                    if (completion.avgHeartRate) {
                                        workoutHtml += ` (Avg HR: ${completion.avgHeartRate})`;
                                    }
                                    if (completion.actualDuration !== Math.round((e.moving_time || e.duration || 3600) / 60)) {
                                        workoutHtml += ` (Actual: ${completion.actualDuration} min)`;
                                    }
                                }
                                
                                workoutHtml += `</li>`;
                                return workoutHtml;
                            }).join('')}
                        </ul>
                    `;
                }
                
                modalContent.innerHTML = `
                    <div class="section">
                        <h3>${headerText}</h3>
                        ${workoutDetailsHtml}
                        ${nutritionCalculator.formatNutritionResults(nutrition)}
                    </div>
                `;
                
                modal.style.display = 'block';
            },

            closeModal() {
                document.getElementById('dayDetailModal').style.display = 'none';
            },
            
            handleModalClick(event) {
                if (event.target === event.currentTarget) this.closeModal();
            },
            
            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.loadCalendarData();
            },
            
            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.loadCalendarData();
            },
            
            goToToday() {
                this.currentDate = new Date();
                this.loadCalendarData();
            },
            
            updateMonthYear() {
                document.getElementById('monthYear').textContent = `${this.currentDate.toLocaleDateString('en-US', { month: 'long' })} ${this.currentDate.getFullYear()}`;
            },
            
            formatDate(date) {
                return date.toISOString().split('T')[0];
            },
            
            formatDateDisplay(date) {
                return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            },
            
            isSameDate(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate();
            }
        };

        // Initialize the enhanced calendar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üóìÔ∏è Enhanced Nutrition Calendar with Completion Tracking Initialized');
            calendarManager.init();
        });
    </script>
</body>
</html>
