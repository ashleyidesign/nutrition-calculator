<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Nutrition Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .button {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            margin-right: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button.secondary {
            background: #6c757d;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .nutrition-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }

        .nutrition-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .macro-item {
            text-align: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .macro-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .macro-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fueling-notes {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .fueling-notes h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .fueling-notes ul {
            margin-left: 20px;
        }

        .fueling-notes li {
            margin-bottom: 5px;
            color: #856404;
        }

        #workoutStatus {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .macro-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÉ‚Äç‚ôÄÔ∏è Workout Nutrition Calculator</h1>
            <p>Daily macros + workout fueling recommendations</p>
            <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                Version 2.3 - Intensity-based carb calculations
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>üîó Load Workout from Intervals.icu</h2>
                
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your API key" value="5b7vz3ozlxd42dqx0udbrq7e2">
                </div>
                
                <div class="form-group">
                    <label for="workoutDate">Workout Date</label>
                    <input type="date" id="workoutDate">
                </div>
                
                <button class="button" onclick="loadWorkoutData()">Load Workout</button>
                <button class="button secondary" onclick="toggleManualEntry()">Manual Entry</button>
                
                <div id="workoutStatus"></div>
            </div>

            <div class="section">
                <h2>üë§ Your Profile</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bodyWeight">Body Weight (lbs)</label>
                        <input type="number" id="bodyWeight" min="100" max="250" value="190">
                    </div>
                    <div class="form-group">
                        <label for="goals">Current Goals</label>
                        <select id="goals">
                            <option value="weight-loss">Weight Loss</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="performance">Performance Focus</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section" id="manualSection" style="display: none;">
                <h2>üìä Manual Workout Entry</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="workoutType">Workout Type</label>
                        <select id="workoutType">
                            <option value="none">Rest Day</option>
                            <option value="easy">Easy/Recovery</option>
                            <option value="endurance">Endurance (Zone 2)</option>
                            <option value="tempo">Tempo (Zone 3)</option>
                            <option value="threshold">Threshold (Zone 4)</option>
                            <option value="intervals">Intervals (Zone 5)</option>
                            <option value="strength">Strength Training</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes)</label>
                        <input type="number" id="duration" min="0" max="480" value="60">
                    </div>
                </div>

                <button class="button" onclick="calculateNutrition()">Calculate My Nutrition Plan</button>
            </div>

            <div class="results" id="results">
                <div class="section">
                    <h2>üéØ Today's Nutrition Plan</h2>
                    
                    <div class="nutrition-card">
                        <h3>Daily Macro Targets</h3>
                        <div class="macro-grid">
                            <div class="macro-item">
                                <div class="macro-value" id="totalCalories">0</div>
                                <div class="macro-label">Calories</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="totalProtein">0g</div>
                                <div class="macro-label">Protein</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="totalCarbs">0g</div>
                                <div class="macro-label">Carbs</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="totalFat">0g</div>
                                <div class="macro-label">Fat</div>
                            </div>
                        </div>
                    </div>

                    <div class="nutrition-card" id="fuelingCard">
                        <h3>Workout Fueling Strategy</h3>
                        <div class="macro-grid">
                            <div class="macro-item">
                                <div class="macro-value" id="preWorkout">0g</div>
                                <div class="macro-label">Pre-Workout Carbs</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="duringWorkout">0g</div>
                                <div class="macro-label">During (per hour)</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="postWorkout">0g</div>
                                <div class="macro-label">Post-Workout Carbs</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="fluidIntake">0ml</div>
                                <div class="macro-label">Fluids (per hour)</div>
                            </div>
                        </div>
                        <div class="fueling-notes" id="fuelingNotes">
                            <h4>Fueling Notes</h4>
                            <ul id="fuelingTips">
                                <li>No specific fueling needed for this workout</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set today's date by default
        document.getElementById('workoutDate').valueAsDate = new Date();
        
        async function loadWorkoutData() {
            const apiKey = document.getElementById('apiKey').value;
            const workoutDate = document.getElementById('workoutDate').value;
            const statusDiv = document.getElementById('workoutStatus');
            
            if (!apiKey || !workoutDate) {
                showStatus('Please enter API key and select date', 'error');
                return;
            }
            
            showStatus('Loading workout data...', 'loading');
            
            try {
                const response = await fetch('/api/intervals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        athleteId: 'i290140',
                        apiKey: apiKey,
                        date: workoutDate
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const activities = data.events || [];
                
                if (activities.length === 0) {
                    showStatus('No workouts found for this date - showing rest day nutrition', 'warning');
                    
                    // Set as rest day and calculate nutrition
                    document.getElementById('workoutType').value = 'none';
                    document.getElementById('duration').value = 0;
                    document.getElementById('manualSection').style.display = 'none';
                    document.querySelector('button.secondary').textContent = 'Show Manual Override';
                    
                    // Calculate rest day nutrition
                    calculateNutrition();
                    return;
                }
                
                // Use the first workout
                const workout = activities[0];
                const workoutType = mapWorkoutType(workout);
                const duration = Math.round((workout.moving_time || 3600) / 60);
                
                document.getElementById('workoutType').value = workoutType;
                document.getElementById('duration').value = duration;
                
                // Hide manual section since we loaded automatically
                document.getElementById('manualSection').style.display = 'none';
                document.querySelector('button.secondary').textContent = 'Show Manual Override';
                
                // Calculate nutrition with loaded data
                calculateNutrition();
                
                showStatus(`Loaded: ${workout.name || workout.type} - ${duration} minutes - ${workoutType.toUpperCase()}`, 'success');
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        function mapWorkoutType(workout) {
            const name = (workout.name || '').toLowerCase();
            const type = (workout.type || '').toLowerCase();
            
            if (name.includes('recovery') || name.includes('easy')) return 'easy';
            if (name.includes('tempo') || name.includes('zone 3')) return 'tempo';
            if (name.includes('threshold') || name.includes('zone 4')) return 'threshold';
            if (name.includes('interval') || name.includes('zone 5')) return 'intervals';
            if (type.includes('strength')) return 'strength';
            
            return 'endurance';
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('workoutStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            const colors = {
                'loading': '#007bff',
                'success': '#28a745',
                'warning': '#ffc107',
                'error': '#dc3545'
            };
            
            statusDiv.style.backgroundColor = colors[type] || '#6c757d';
            statusDiv.style.color = 'white';
        }
        
        function toggleManualEntry() {
            const manualSection = document.getElementById('manualSection');
            const isVisible = manualSection.style.display !== 'none';
            
            manualSection.style.display = isVisible ? 'none' : 'block';
            event.target.textContent = isVisible ? 'Manual Entry' : 'Hide Manual Entry';
        }
        
        function calculateNutrition() {
            const bodyWeight = parseInt(document.getElementById('bodyWeight').value);
            const goals = document.getElementById('goals').value;
            const workoutType = document.getElementById('workoutType').value;
            const duration = parseInt(document.getElementById('duration').value);
            
            console.log(`Calculating: ${bodyWeight}lbs, ${goals}, ${workoutType}, ${duration}min`);
            
            let dailyCalories, dailyProtein, dailyFat, dailyCarbs;
            
            if (goals === 'weight-loss') {
                // Match Fuelin's targets exactly
                dailyProtein = Math.round(bodyWeight * 0.78); // ~148g at 190lbs
                dailyFat = Math.round(bodyWeight * 0.41); // ~78g at 190lbs
                
                // Carb formula based on workout intensity AND duration
                if (workoutType === 'none') {
                    dailyCarbs = Math.round(bodyWeight * 0.885); // Rest day ~170g at 192lbs
                } else {
                    // Base carbs by intensity level
                    const intensityMultipliers = {
                        'easy': 1.0,      // Easy recovery
                        'endurance': 1.1, // Zone 2 (~210g at 190lbs)
                        'tempo': 1.6,     // Zone 3 (~304g at 190lbs)
                        'threshold': 1.7, // Zone 4
                        'intervals': 1.8, // Zone 5
                        'strength': 1.2   // Strength training
                    };
                    
                    const baseCarbs = bodyWeight * intensityMultipliers[workoutType];
                    
                    // Adjust slightly for duration (longer workouts need more carbs)
                    let durationAdjustment = 1.0;
                    if (duration > 120) durationAdjustment = 1.1;      // +10% for 2+ hours
                    else if (duration > 90) durationAdjustment = 1.05; // +5% for 90+ min
                    
                    dailyCarbs = Math.round(baseCarbs * durationAdjustment);
                }
                
                // Calculate total calories from macros
                dailyCalories = (dailyProtein * 4) + (dailyFat * 9) + (dailyCarbs * 4);
                
            } else if (goals === 'maintenance') {
                const bodyWeightKg = bodyWeight * 0.453592;
                dailyProtein = Math.round(bodyWeightKg * 1.6);
                dailyFat = Math.round(bodyWeight * 0.5);
                dailyCarbs = Math.round(bodyWeight * 1.8);
                dailyCalories = (dailyProtein * 4) + (dailyFat * 9) + (dailyCarbs * 4);
                
            } else { // performance
                const bodyWeightKg = bodyWeight * 0.453592;
                dailyProtein = Math.round(bodyWeightKg * 1.4);
                dailyFat = Math.round(bodyWeight * 0.6);
                dailyCarbs = Math.round(bodyWeight * 2.0);
                dailyCalories = (dailyProtein * 4) + (dailyFat * 9) + (dailyCarbs * 4);
            }
            
            console.log(`Results: ${dailyCalories} cal, ${dailyProtein}p, ${dailyCarbs}c, ${dailyFat}f`);
            
            // Workout fueling calculations
            const bodyWeightKg = bodyWeight * 0.453592;
            let preWorkoutCarbs = 0;
            let duringWorkoutCarbs = 0;
            let postWorkoutCarbs = 0;
            let fluidIntake = 0;
            let fuelingTips = [];
            
            if (workoutType === 'none') {
                fuelingTips.push('Rest day - focus on recovery nutrition');
            } else if (duration < 60) {
                preWorkoutCarbs = Math.round(bodyWeightKg * 0.5);
                fluidIntake = 400;
                postWorkoutCarbs = Math.round(bodyWeightKg * 0.8);
                fuelingTips.push('Pre: 1-2 hours before workout');
                fuelingTips.push('Post: Within 30 minutes after workout');
            } else {
                preWorkoutCarbs = Math.round(bodyWeightKg * 0.7);
                duringWorkoutCarbs = duration < 120 ? 25 : 35;
                postWorkoutCarbs = Math.round(bodyWeightKg * 1.0);
                fluidIntake = 500;
                fuelingTips.push('Pre: 1-2 hours before workout');
                fuelingTips.push('During: Start fueling after 60 minutes');
                fuelingTips.push('Post: Within 30 minutes');
            }
            
            // Update display
            document.getElementById('totalCalories').textContent = dailyCalories;
            document.getElementById('totalProtein').textContent = dailyProtein + 'g';
            document.getElementById('totalCarbs').textContent = dailyCarbs + 'g';
            document.getElementById('totalFat').textContent = dailyFat + 'g';
            
            document.getElementById('preWorkout').textContent = preWorkoutCarbs + 'g';
            document.getElementById('duringWorkout').textContent = duringWorkoutCarbs + 'g';
            document.getElementById('postWorkout').textContent = postWorkoutCarbs + 'g';
            document.getElementById('fluidIntake').textContent = fluidIntake + 'ml';
            
            const tipsList = document.getElementById('fuelingTips');
            tipsList.innerHTML = '';
            fuelingTips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                tipsList.appendChild(li);
            });
            
            const fuelingCard = document.getElementById('fuelingCard');
            fuelingCard.style.display = workoutType === 'none' ? 'none' : 'block';
            
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Auto-calculate when values change
        ['workoutType', 'duration', 'bodyWeight', 'goals'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                if (document.getElementById('results').style.display === 'block') {
                    calculateNutrition();
                }
            });
        });
        
        // Auto-calculate rest day nutrition when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Set default to rest day and calculate
            document.getElementById('workoutType').value = 'none';
            document.getElementById('duration').value = 0;
            calculateNutrition();
        });
    </script>
</body>
</html>
